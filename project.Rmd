---
title: "Project"
output: html_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.



```{r}
install.packages("jsonlite")
library(jsonlite)
require(jsonlite)

business.file <- 'C:/Users/Phuong/Documents/R/Bio 260/yelp_dataset_challenge_academic_dataset/yelp_academic_dataset_business.json'

business <- stream_in(file(business.file))

save(business,file='C:/Users/Phuong/Documents/R/Bio 260/business.RData')

#rm(business)
```

```{r}
review.file <- 'C:/Users/Phuong/Documents/R/Bio 260/yelp_dataset_challenge_academic_dataset/yelp_academic_dataset_review.json'

review <- stream_in(file(review.file))

save(review,file='C:/Users/Phuong/Documents/R/Bio 260/review.RData')

#rm(review)
```

```{r}
user.file <- 'C:/Users/Phuong/Documents/R/Bio 260/yelp_dataset_challenge_academic_dataset/yelp_academic_dataset_user.json'

user <- stream_in(file(user.file))

save(user,file='C:/Users/Phuong/Documents/R/Bio 260/user.RData')

#rm(user)
```

```{r}
# set working directory
# Loading RData
library(dplyr)
library(tidyr)


y<-load("business.RData")
rm(y)

r <-load("review.RData")
rm(r)

u<-load("user.RData")
rm(u)
```

```{r}
# Data wrangling
lapply(business, class)
lapply(review,class)


```

```{r}
#table(business$state)

#Filter Restaurants in categories and states AZ,NV, NC,QC (states with more than 2000 restaurants)

#getting the index
business_restaurant_index <- which(grepl("Restaurants",business$categories) & business$state %in% c("QC","PA"))

#getting business id by index
business_restaurant_id <- business$business_id[business_restaurant_index]

review_restaurant_index <- which(review$business_id %in% business_restaurant_id)

review_restaurant_id <- review[review_restaurant_index,"review_id"]

# Filter review by review_id
review <- review[review$review_id %in% review_restaurant_id,]

#Filter business by business_id
business <-business[business$business_id %in% business_restaurant_id,] 

```


```{r,message=F,warning=F}

# Mexican, fast food, American, Asian, Europeans, Latin Americans

business$Mexican=NA
business$Fastfood=NA
business$American=NA
business$Asian=NA
business$European=NA

ff <- data.frame()
mex <- data.frame()
asia <- data.frame()
america <- data.frame()
european <- data.frame()

for (i in 1:length(business$categories)){
  ff<-rbind(ff,ifelse("Fast Food" %in% business$categories[[i]],1,0))
  mex <- rbind(mex, ifelse("Mexican" %in% business$categories[[i]],1,0))
  # asia <- rbind(asia,ifelse(c("Chinese","Japanese","Asian Fusion","Thai","Indian","Taiwanese","Vietnamese","Korean") %in% business$categories[[i]],1,0))
  asia <- rbind(asia,ifelse("Chinese" %in% business$categories[[i]]|"Japanese" %in% business$categories[[i]]|"Asian Fusion" %in% business$categories[[i]]|"Thai" %in% business$categories[[i]]|"Indian" %in% business$categories[[i]]|"Taiwanese" %in% business$categories[[i]]|"Vietnamese" %in% business$categories[[i]]|"Korean" %in% business$categories[[i]],1,0))
  america <- rbind(america,ifelse("American (New)" %in% business$categories[[i]]|"American (Traditional)" %in% business$categories[[i]],1,0))
  # european<-rbind(european,ifelse(c("Italian","French","Irish","Greek","Austrian","British","German") %in% business$categories[[i]],1,0))
   european <- rbind(european,ifelse("Italian" %in% business$categories[[i]]|"French" %in% business$categories[[i]]|"Irish" %in% business$categories[[i]]|"Greek" %in% business$categories[[i]]|"Austrian" %in% business$categories[[i]]|"British" %in% business$categories[[i]]|"German" %in% business$categories[[i]],1,0))
}



colnames(ff)[1]<- "Fastfood"
colnames(asia)[1]<-"Asia"
colnames(mex)[1] <- "Mexico"
colnames(america)[1] <- "America"
colnames(european)[1] <- "European"

business$Fastfood <- ff$Fastfood
business$Asian <-asia$Asia
business$Mexican <-mex$Mexico
business$American <- america$America
business$European <-european$European


rm(ff)
rm(asia)
rm(mex)
rm(america)
rm(european)


```

```{r}
#Attributes: wifi, smoking, reservation, delivery, parking, credit card, happy hour, take out, drive thru
business$feature <- NA

#save all feature as a seperate data frame
tempA <- data.frame()

#reservation- false 11979, true 6042
tempA <- ifelse(business$attributes$`Takes Reservations`==TRUE,1,0) %>% as.data.frame()
colnames(tempA)[1]<- "reservation"

#delivery- false 14543, true 3364
tempA$delivery <- NA
tempA$delivery <- ifelse(business$attributes$Delivery==TRUE,1,0)

#credit card- false 397, true 18433
tempA$card <- NA
tempA$card <- ifelse(business$attributes$`Accepts Credit Cards`==TRUE,1,0)

#happy hour- false 238, true 1569
tempA$hh <- NA
tempA$hh <- ifelse(business$attributes$`Happy Hour`==TRUE,1,0) ##A lot NA, may remove

#take out- false 1385, true 16969
tempA$takeout <- NA
tempA$takeout <- ifelse(business$attributes$`Take-out`==TRUE,1,0)

#drive thru- false 1486, true 1387
tempA$drivethru <- NA
tempA$drivethru <- ifelse(business$attributes$`Drive-Thru`==TRUE,1,0) ##A lot NA, may remove

#Wifi- free 5224, no 8511, paid 118 - free+paid=1/no=0
tempA$wifi <- NA
tempA$wifi <- ifelse(business$attributes$`Wi-Fi`=="no",0,1) ##A lot NA

#smoking- no 636, outdoor 783, yes 239 - outdoor+yes=1/no=0
tempA$smoking <- NA
tempA$smoking <- ifelse(business$attributes$Smoking=="no",0,1) ##A lot NA

#parking- garage, street, validated, lot, valet - anyone returns true will be 1/otherwise 0
tempA$parking <- NA
tempA$parking <- ifelse(business$attributes$Parking$garage==TRUE|business$attributes$Parking$street==TRUE|business$attributes$Parking$validated==TRUE|business$attributes$Parking$lot==TRUE|business$attributes$Parking$valet==TRUE,1,0)

#Deal with NAs (replace NA to 0)??
tempA <- tempA %>% replace_na(list(reservation=0, delivery=0, card=0, hh=0, takeout=0, drivethru=0, wifi=0, smoking=0, parking=0))

#Sum up to features
tempA <- mutate(tempA, feature = reservation + delivery + card + hh + takeout + drivethru + wifi + smoking + parking)

business$feature <- tempA$feature

```


More wrangling

```{r, message=F,warning=F}
# select some columns of review and make it not a data.frame
tempB <- review%>%select(business_id,stars)
tempB <- tempB%>%mutate(vote_funny=review$votes$funny,
                        vote_useful=review$votes$useful,
                        vote_cool=review$votes$cool)
#group_by business 
r<-tempB%>%
  group_by(business_id)%>%
  summarise(votes_funny=sum(vote_funny),
            votes_useful=sum(vote_useful),
            votes_cool=sum(vote_cool),
            avg_star=mean(stars))
rm(tempB)

# select columns in business
business_data <- business%>%
  select(business_id,full_address,city,review_count,
         state,stars,feature)

#add other column of types data.frame to clean up the data.frame inside a data.frame
business_data<-business_data%>%mutate(Mexican=business$Mexican,
                                      American=business$American,
                                      fast_food=business$Fastfood,
                                      European=business$European,
                                      Asian=business$Asian)

#left_join the review columns with the business file 
business_data <- left_join(business_data,r,by="business_id")
business_data <- business_data%>%mutate(avg_star=round(avg_star,digits=1))

#separate the zip code
business_data <- business_data %>% separate(full_address, c("address", "state_zc"), sep = ", ")
business_data <- business_data %>% separate(state_zc, c("st", "zip_code"), sep = "\\ ")
business_data <- business_data %>% select(-c(st,address,city))


```

```{r}
library(tidytext)

review_text<-review %>%
    select(business_id,text)%>%
    unnest_tokens(word, text)%>%
    filter(!word %in% stop_words$word)

nrc <- sentiments %>%
    filter(lexicon == "nrc") %>%
    select(word, sentiment)

review_sentiment <- review_text %>%
    inner_join(nrc) %>%
     count(business_id,sentiment)%>%
    spread(sentiment, n, fill = 0) %>%
    mutate(positivity = (positive - negative) / (positive + negative + 1))

# join with business_data
# use positivity

 

business_data <- review_sentiment%>%
  select(c(business_id,positivity))%>%
  left_join(business_data)
  
# state
business_data<- business_data%>%
  mutate(QC=ifelse(state=="QC",1,0))%>%
  mutate(NC=ifelse(state=="NC",1,0))

business_data <- business_data%>%
  select(-c(zip_code,state)) #cannot delete business_id? 

# change the star columns in both review and business_data

business_data1<-business_data%>%
  mutate(stars=ifelse(stars >= 0 & stars<=1,1,
                ifelse(stars>1 & stars<=2,2,
                ifelse(stars>2 & stars<3,3,
                ifelse(stars>3 & stars<=4,4,5)))))

business_data1 <- subset(business_data, select = -c(business_id) ) #with stars change

business_data <- subset(business_data, select = -c(business_id) ) # without stars change


```


```{r}
# exploratory analysis
# graph, word cloud
library("wordcloud")


```

# Cross Validation
```{r}
# cross validation
 
library(caret)
# create train set and test set with 80% in train and 20% in test
inTrain <- createDataPartition(y = business_data1$stars, p=0.8)
train_set <- slice(business_data1, inTrain$Resample1)
test_set <- slice(business_data1, -inTrain$Resample1)

#run 10 cross validations leaving out 20% of the data
control <- trainControl(method='cv', number=10, p=.8) 

#with the business_data (no change in stars)
inTrain1 <- createDataPartition(y = business_data$stars, p=0.8)
training <- slice(business_data, inTrain$Resample1)
testing <- slice(business_data, -inTrain$Resample1)
```

#Fitting models


```{r,message=F,warning=F}
# fitting different models 
# classification 
# GLM (Logistic Regression)

fit1 <- glm(y~., data=mutate(train_set,
                                   y=stars==1),family="binomial")
fit2 <- glm(y~., data=mutate(train_set,
                                   y=stars==2),family="binomial")
fit3 <- glm(y~., data=mutate(train_set,
                                   y=stars==3),family="binomial")
fit4 <- glm(y~., data=mutate(train_set,
                                   y=stars==4),family="binomial")
fit5<- glm(y~., data=mutate(train_set,
                                   y=stars==5),family="binomial")

f_hat1 <- predict(fit1, newdata = test_set, type = "response")
f_hat2 <- predict(fit2, newdata = test_set, type ="response")
f_hat3 <- predict(fit3, newdata = test_set, type = "response")
f_hat4 <- predict(fit4, newdata = test_set, type ="response")
f_hat5 <- predict(fit5, newdata = test_set, type = "response")

# warning messages? 

pred_glm <- apply(cbind(f_hat1, f_hat2, f_hat3,f_hat4,f_hat5),1,which.max)

```

```{r}
# fit business_data without change of stars
#fitting lm
library(broom)
 

#remove states in business_data
data<-business_data%>%select(-c(NC,QC))
res_lm1 <- data%>%
  lm(stars ~ ., data = .)


summary(res_lm1)
#remove European
#non-significance

#fit some variables 
res_lm2 <- data%>%
  lm(stars ~positivity + review_count + feature + Mexican + American + fast_food + Asian + votes_funny + votes_useful + votes_cool + avg_star, data = .)

summary(res_lm2) #remove Mexican

res_lm3 <- data%>%
  lm(stars ~positivity + review_count + feature + American + fast_food + Asian + votes_funny + votes_useful + votes_cool + avg_star, data = .)

summary(res_lm3) #remove fast food

res_lm3 <- data%>%
  lm(stars ~positivity + review_count + feature  + American + Asian + votes_funny + votes_useful + votes_cool + avg_star, data = .)

summary(res_lm3) #remove feature

res_lm4 <- data%>%
  lm(stars ~positivity + review_count  + American + Asian + votes_funny + votes_useful + votes_cool + avg_star, data = .)

summary(res_lm4) #remove Asian

res_lm4 <- data%>%
  lm(stars ~positivity + review_count  + American + Asian + votes_funny + votes_useful + votes_cool + avg_star, data = .)

summary(res_lm4) #remove Asian

res_lm5 <- data%>%
  lm(stars ~positivity + review_count  + American + votes_funny + votes_useful + votes_cool + avg_star, data = .)

summary(res_lm5) #remove vote_useful

res_lm5 <- data%>%
  lm(stars ~positivity + review_count  + American + votes_funny  + votes_cool + avg_star, data = .)

summary(res_lm5) #remove vote_funny

res_lm6 <- data%>%
  lm(stars ~positivity + review_count  + American + votes_cool + avg_star, data = .)

summary(res_lm6) #remove votes_cool

res_lm7 <- data%>%
  lm(stars ~positivity + review_count  + American  + avg_star, data = .)

summary(res_lm7) #remove review_count

res_lm8 <- data%>%
  lm(stars ~positivity   + American  + avg_star, data = .)

summary(res_lm8) #remove American


res_lm8 <- data%>%
  lm(stars ~positivity  + avg_star, data = .)

summary(res_lm8) # only positivity and avg_star 



#backward selection, remove the high non-significant, and then do again until getting all significant


```


```{r}
#KNN
res <- train(as.factor(stars) ~ .,
             data = business_data1,
             method = "knn",
             trControl = control,
             tuneLength = 1, # How fine a mesh to go on grid
             tuneGrid=data.frame(k=seq(1,100,5)),
             metric="Accuracy")
#don't have accuracy 

plot(res)

res$results %>% 
  ggplot(aes(k, Accuracy, ymin= Accuracy - AccuracySD, 
             ymax = Accuracy + AccuracySD)) +
  geom_point() + geom_errorbar()
#k=16

res

# fit with k=16
fit <- knn3(stars~., data=train_set, k=16)
f_hat <- predict(fit, newdata = test_set)
pred_knn_16 <- apply(f_hat,1,which.max)



```

```{r,message=F,warning=F}
#SVM
#install.packages("e1071")
library(e1071)
fit_svm <- svm(stars~.,data=train_set) 
pred_svm <-predict(fit_svm,newdata=test_set)

# Random Forest
fit_rr<-randomForest(stars~.,data=train_set)
pred_rr<-predict(fit_rr,newdata=test_set)

```

```{r}


RMSE <- function(true_ratings, predicted_ratings){
    sqrt(mean((true_ratings - predicted_ratings)^2))
}

rmse_glm <- RMSE(test_set$stars,pred_glm)
rmse_glm #0.41

rmse_knn_16<- RMSE(test_set$stars,pred_knn_16)
rmse_knn_16 #2.833

rmse_svm <- RMSE(test_set$stars,pred_svm)
rmse_svm #0.373

rmse_rr <- RMSE(test_set$stars,pred_rr)
rmse_rr #0.218
```

```{r}
#plots to compare methods

```
Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
